# KillrVideo 2025 – Python FastAPI Backend

A reference backend for the KillrVideo sample application rebuilt for 2025 using **FastAPI**, **Poetry** and **DataStax Astra DB**.

---

## Overview
This repo demonstrates modern API best-practices with:

* FastAPI & Pydantic v2 for typed request/response models
* Role-based JWT auth
* Async Cassandra (Astra DB) driver via `astrapy`
* Ruff + MyPy for quality gates
* Pytest suite (~150 tests)
* Micro-service friendly layout – or run everything as a monolith

---

## Prerequisites
1. **Python 3.10+** (use pyenv or asdf)
2. **Poetry** for dependency management:  
   `pip install "poetry==1.7.1"`
3. A **DataStax Astra DB** serverless database – grab a free account.
4. Docker (optional) if you want to run the individual services in containers.

---

## Setup & Configuration
```bash
# clone
git clone https://github.com/your-org/killrvideo-python-fastapi-backend.git
cd killrvideo-python-fastapi-backend

# install deps (creates .venv)
poetry install

# copy env template & fill in Astra creds and SECRET_KEY
cp .env.example .env
```

Environment variables (all live in `.env`):

| Variable | Description |
|----------|-------------|
| `ASTRA_DB_API_ENDPOINT` | REST endpoint for your Astra DB instance |
| `ASTRA_DB_APPLICATION_TOKEN` | Token created in Astra UI |
| `ASTRA_DB_KEYSPACE` | Keyspace name |
| `SECRET_KEY` | JWT signing secret |

---

## Running the Application
### 1. Monolith (combined services)
```bash
poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```
Docs: <http://localhost:8000/docs>

### 2. Individual Micro-services
| Service | Entry-point | Port (example) | Docs URL |
|---------|------------|---------------|----------|
| **user-svc** | `app.main_user:service_app` | 8001 | /docs |
| **video-svc** | `app.main_video:service_app` | 8002 | /docs |
| **comment-svc** | `app.main_comment:service_app` | 8003 | /docs |
| **reco-svc** | `app.main_reco:service_app` | 8004 | /docs |

Run one:
```bash
poetry run uvicorn app.main_video:service_app --reload --port 8002
```

---

## Linting & Type Checking
```bash
poetry run ruff check .        # lint
poetry run ruff format .       # auto-format
poetry run mypy .              # static types
```

---

## Running Tests
```bash
poetry run pytest              # run all tests
poetry run pytest -v           # verbose
poetry run pytest --cov=app    # with coverage (needs pytest-cov)
```

---

## Project Structure
```
app/
  api/v1/endpoints/   # FastAPI routers per feature
  models/             # Pydantic domain models
  services/           # Business-logic layer
  db/                 # Astra client helpers
  core/               # config, security, utils
  main.py             # monolith entrypoint
  main_*.py           # per-service entrypoints
services_dockerfiles/ # Dockerfiles per service
```

---

## Building & Running with Docker
```bash
# user service
docker build -t killrvideo/user-svc -f services_dockerfiles/user.Dockerfile .
docker run -p 8001:8000 --env-file .env killrvideo/user-svc

# video service
docker build -t killrvideo/video-svc -f services_dockerfiles/video.Dockerfile .
docker run -p 8002:8000 --env-file .env killrvideo/video-svc
```

(Repeat for **comment-svc** & **reco-svc**.)

---

## API Specification
The OpenAPI schema is autogenerated by FastAPI and served at `/openapi.json` for each service (or `/api/v1/<svc>/openapi.json` when running monolith). 